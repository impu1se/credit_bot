package main

import (
	"fmt"
	"log"
	"net/http"
	"os"
	"time"

	tgbotapi "github.com/Syfaro/telegram-bot-api"
)

const (
	url      = "https://credit-bot-for-yan.herokuapp.com/"
	apiToken = "843667644:AAEB7-te7PfsX2depO8nkeU3ZvNbEyDVpIk"
	credit30 = `
–ù–∏–∂–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –ø–æ–¥ –≤–∞—à –∑–∞–ø—Ä–æ—Å.

–ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∑–∞–π–º –¥–æ 30 —Ç—ã—Å. —Ä—É–±. –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–π—Ç–∏ –ø–æ –æ–¥–Ω–æ–π –∏–∑ —Å—Å—ã–ª–æ–∫ –Ω–∏–∂–µ –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É –Ω–∞ —Å–∞–π—Ç–µ. (–í —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç –¥–µ–Ω—å–≥–∏ –ø—Ä–∏–¥—É—Ç –≤–∞–º –Ω–∞ –∫–∞—Ä—Ç—É):

‚¨áÔ∏è–ö–æ–º–ø–∞–Ω–∏–∏ –≤ –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É:

–ï-–ö–∞–ø—É—Å—Ç–∞ - –ø–µ—Ä–≤—ã–π –∑–∞–π–º –¥–æ 30 000 —Ä—É–±. –±–µ–∑ –ø–µ—Ä–µ–ø–ª–∞—Ç—ã
‚û°Ô∏è https://bit.ly/2YEuzyi (–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É)

–†–æ–±–æ—Ç –ó–∞–π–º–µ—Ä - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–¥–æ–±—Ä–µ–Ω–∏–µ –¥–æ 30 000 —Ä—É–±
‚û°Ô∏è https://bit.ly/2JhC5dd (–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É)

Onzaem - –ø–µ—Ä–≤—ã–π –∑–∞–π–º –æ—Ç 2 000 –¥–æ 30 000 —Ä—É–±–ª–µ–π. –°—Ç–∞–≤–∫–∞ 1.5%
‚û°Ô∏è https://bit.ly/32eNRg4 (–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É)

–î–µ–Ω—å–≥–∏ –°—Ä–∞–∑—É - –ø–µ—Ä–≤—ã–π –∑–∞–π–º –¥–æ 30 000 —Ä—É–±. –±–µ–∑ –ø–µ—Ä–µ–ø–ª–∞—Ç—ã
‚û°Ô∏è https://bit.ly/2XSvoGF (–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É)

Moneza - –ø–µ—Ä–≤—ã–π –∑–∞–π–º –¥–æ 30 000 —Ä—É–±. –±–µ–∑ –ø–µ—Ä–µ–ø–ª–∞—Ç—ã
‚û°Ô∏è https://bit.ly/2XtEHZp (–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É)

–°–æ–≤–µ—Ç: –ß—Ç–æ–±—ã —É–≤–µ–ª–∏—á–∏—Ç—å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∏ —Å–∫–æ—Ä–æ—Å—Ç—å –æ–¥–æ–±—Ä–µ–Ω–∏—è –∑–∞–π–º–∞, –æ—Å—Ç–∞–≤—å—Ç–µ –∞–Ω–∫–µ—Ç—ã —Å—Ä–∞–∑—É –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–æ–º–ø–∞–Ω–∏—è—Ö!
`
	credit15 = `
–ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∑–∞–π–º –¥–æ 15 —Ç—ã—Å. —Ä—É–±. –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–π—Ç–∏ –ø–æ –æ–¥–Ω–æ–π –∏–∑ —Å—Å—ã–ª–æ–∫ –Ω–∏–∂–µ –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É –Ω–∞ —Å–∞–π—Ç–µ. (–í —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç –¥–µ–Ω—å–≥–∏ –ø—Ä–∏–¥—É—Ç –≤–∞–º –Ω–∞ –∫–∞—Ä—Ç—É):

‚¨áÔ∏è–ö–æ–º–ø–∞–Ω–∏–∏ –≤ –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É:

Kredito24 - –ø–µ—Ä–≤—ã–π –∑–∞–π–º –¥–æ 15 000 —Ä—É–±. –°—Ç–∞–≤–∫–∞ 1,5%
‚û°Ô∏è https://bit.ly/2LKfnMJ (–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É)

E-zaem - –ø–µ—Ä–≤—ã–π –∑–∞–π–º –¥–æ 15 000 —Ä—É–±. –±–µ–∑ –ø–µ—Ä–µ–ø–ª–∞—Ç
‚û°Ô∏è https://bit.ly/2YAhdTD (–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É)

Metrokredit - –ø–µ—Ä–≤—ã–π –∑–∞–π–º –¥–æ 15 000 —Ä—É–±–ª–µ–π. –±–µ–∑ –ø–µ—Ä–µ–ø–ª–∞—Ç
‚û°Ô∏è https://bit.ly/30nAkB7 (–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É)

SmartCredit - –ø–µ—Ä–≤—ã–π –∑–∞–π–º –¥–æ 15 000 —Ä—É–±. 
–ó–∞–ø—É—Å—Ç–∏–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º—É –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ - —Å—Ç–∞–≤–∫–∞ 0.95%
‚û°Ô∏è https://bit.ly/2JfDW2a (–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É)

CreditPlus - –ø–µ—Ä–≤—ã–π –∑–∞–π–º –¥–æ 15 000 —Ä—É–±. –±–µ–∑ –ø–µ—Ä–µ–ø–ª–∞—Ç—ã
‚û°Ô∏è https://bit.ly/2Xx1atp (–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É)

–°–æ–≤–µ—Ç: –ß—Ç–æ–±—ã —É–≤–µ–ª–∏—á–∏—Ç—å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∏ —Å–∫–æ—Ä–æ—Å—Ç—å –æ–¥–æ–±—Ä–µ–Ω–∏—è –∑–∞–π–º–∞, –æ—Å—Ç–∞–≤—å—Ç–µ –∞–Ω–∫–µ—Ç—ã —Å—Ä–∞–∑—É –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–æ–º–ø–∞–Ω–∏—è—Ö!`

	credit50 = `
–ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∑–∞–π–º –¥–æ 50 —Ç—ã—Å. —Ä—É–±. –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–π—Ç–∏ –ø–æ –æ–¥–Ω–æ–π –∏–∑ —Å—Å—ã–ª–æ–∫ –Ω–∏–∂–µ –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É –Ω–∞ —Å–∞–π—Ç–µ. (–í —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç –¥–µ–Ω—å–≥–∏ –ø—Ä–∏–¥—É—Ç –≤–∞–º –Ω–∞ –∫–∞—Ä—Ç—É):

‚¨áÔ∏è–ö–æ–º–ø–∞–Ω–∏–∏ –≤ –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É:

–¢—É—Ä–±–æ–∑–∞–π–º - –ø–µ—Ä–≤—ã–π –∑–∞–π–º –æ—Ç 10 000 –¥–æ 50 000. –°—Ç–∞–≤–∫–∞ 0,8%
 ‚û°Ô∏è https://bit.ly/2S5aVt2 (–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É)

GreenMoney- –ø–µ—Ä–≤—ã–π –∑–∞–π–º –¥–æ 40 000 —Ä—É–±. –°—Ç–∞–≤–∫–∞ 0,95%
‚û°Ô∏è https://bit.ly/2RWrLKs (–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É)

–ë—ã—Å—Ç—Ä–æ–¥–µ–Ω—å–≥–∏ - –ø–µ—Ä–≤—ã–π –∑–∞–π–º –¥–æ 50 000 —Ä—É–±–ª–µ–π. 
‚û°Ô∏è https://bit.ly/2Xw5QQ8 (–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É)

–°–æ–≤–µ—Ç: –ß—Ç–æ–±—ã —É–≤–µ–ª–∏—á–∏—Ç—å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∏ —Å–∫–æ—Ä–æ—Å—Ç—å –æ–¥–æ–±—Ä–µ–Ω–∏—è –∑–∞–π–º–∞, –æ—Å—Ç–∞–≤—å—Ç–µ –∞–Ω–∫–µ—Ç—ã —Å—Ä–∞–∑—É –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–æ–º–ø–∞–Ω–∏—è—Ö!`
	welcome = `
–ë–æ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–º–∏ –∫–æ–º–ø–∞–Ω–∏—è–º–∏!

–ü–µ—Ä–µ–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –ª—é–±—ã–º —É–¥–æ–±–Ω—ã–º –¥–ª—è –≤–∞—Å —Å–ø–æ—Å–æ–±–æ–º.

P.S. –ú—ã –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω—ã –≤ —Ç–æ–º, —á—Ç–æ–±—ã –≤—ã –ø–æ–ª—É—á–∏–ª–∏ –∑–∞–π–º! –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —Å–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥ –Ω—É–∂–Ω–æ–π –≤–∞–º —Å—É–º–º—ã —É–∂–µ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏!
–ö–∞–∫–∞—è —Å—É–º–º–∞ –≤–∞–º –Ω—É–∂–Ω–∞?

‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è`

	afterStart = `
–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, %v!
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–≤ –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –∑–∞–π–º —É –Ω–∞—à–µ–≥–æ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –ï - –∫–∞–ø—É—Å—Ç–∞.
–î–ª—è –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ 30.000 ‚ÇΩ –ø–æ–¥ 0 %% (—Å–∫–æ–ª—å–∫–æ –≤–∑—è–ª–∏ —Å—Ç–æ–ª—å–∫–æ –∏ –æ—Ç–¥–∞–µ—Ç–µ) –¥–æ 30 –¥–Ω–µ–π –æ—Å—Ç–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É –∑–¥–µ—Å—å: https://bit.ly/2YEuzyi (–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É)

üí¨ –ò–ª–∏ –Ω–∞—á–Ω–∏—Ç–µ –ø–æ–¥–±–æ—Ä –¥—Ä—É–≥–∏—Ö –∑–∞–π–º–æ–≤.`
	timerText = `
üí≥‚Å£ –ó–ê–ô–ú –ë–ï–ó –ü–†–û–¶–ï–ù–¢–û–í üì¢
–î–∞-–¥–∞, —Å–∫–æ–ª—å–∫–æ –≤–∑—è–ª–∏, —Å—Ç–æ–ª—å–∫–æ –æ—Ç–¥–∞–ª–∏. –ü—Ä–æ—Ü–µ–Ω—Ç–æ–≤ - –ù–ï–¢‚ùóÔ∏è

üìå –®–∞–Ω—Å –æ–¥–æ–±—Ä–µ–Ω–∏—è 98% 
üìå –ù–µ—Ç—É –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –ø–æ –ø–µ—Ä–µ–ø–ª–∞—Ç–∞–º
üìå –°–∞–º—ã–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω–∞ —Ä—ã–Ω–∫–µ

–û—Ñ–æ—Ä–º–∏—Ç–µ –∑–∞—è–≤–∫—É –∑–∞ 1 –º–∏–Ω—É—Ç—É –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å üëá

E-zaem - –ø–µ—Ä–≤—ã–π –∑–∞–π–º –¥–æ 15 000 —Ä—É–±. –±–µ–∑ –ø–µ—Ä–µ–ø–ª–∞—Ç
‚û°Ô∏è https://bit.ly/2YAhdTD (–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É)

–ï-–ö–∞–ø—É—Å—Ç–∞ - –ø–µ—Ä–≤—ã–π –∑–∞–π–º –¥–æ 30 000 —Ä—É–±. –±–µ–∑ –ø–µ—Ä–µ–ø–ª–∞—Ç—ã
‚û°Ô∏è https://bit.ly/2YEuzyi (–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É)

CreditPlus - –ø–µ—Ä–≤—ã–π –∑–∞–π–º –¥–æ 15 000 —Ä—É–±. –±–µ–∑ –ø–µ—Ä–µ–ø–ª–∞—Ç—ã
‚û°Ô∏è https://bit.ly/2Xx1atp (–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É)
`
)

var firstBtn = tgbotapi.NewReplyKeyboard(
	tgbotapi.NewKeyboardButtonRow(
		tgbotapi.NewKeyboardButton("–ü–æ–ª—É—á–∏—Ç—å –∑–∞–π–º üí∏"),
	),
)
var secondBtn = tgbotapi.NewReplyKeyboard(
	tgbotapi.NewKeyboardButtonRow(
		tgbotapi.NewKeyboardButton("–î–æ 15.000—Ä üí∞"),
	),
	tgbotapi.NewKeyboardButtonRow(
		tgbotapi.NewKeyboardButton("–î–æ 30.000—Ä üí∞"),
	),
	tgbotapi.NewKeyboardButtonRow(
		tgbotapi.NewKeyboardButton("–î–æ 50.000—Ä üí∞"),
	),
)

func main() {

	fmt.Println("Running bot...")
	bot, err := tgbotapi.NewBotAPI(apiToken)
	if err != nil {
		log.Panic(err)
	}

	bot.Debug = true
	log.Printf("Authorized on account %s", bot.Self.UserName)
	_, err = bot.SetWebhook(tgbotapi.NewWebhook(url))
	if err != nil {
		log.Fatal(err)
	}
	info, err := bot.GetWebhookInfo()
	if err != nil {
		log.Fatal(err)
	}
	if info.LastErrorDate != 0 {
		log.Printf("Telegram callback failed: %s", info.LastErrorMessage)
	}

	var counter int64
	lastUpdate := make(map[int64]time.Time)
	ticker := time.NewTicker(1 * time.Hour)

	updates := bot.ListenForWebhook("/")
	go http.ListenAndServe(":"+os.Getenv("PORT"), nil)
	fmt.Println("Start serve")
	for {
		select {
		case update := <-updates:
			if update.Message == nil {
				return
			}
			chatID := update.Message.Chat.ID
			if update.Message.IsCommand() {
				switch update.Message.Command() {
				case "start":
					counter++
					lastUpdate[chatID] = time.Now()
					msg := tgbotapi.NewMessage(chatID, fmt.Sprintf(afterStart, update.Message.Chat.UserName))
					msg.ReplyMarkup = firstBtn
					if _, err := bot.Send(msg); err != nil {
						panic(err)
					}
				case "stat":
					msg := tgbotapi.NewMessage(chatID, fmt.Sprintf("%v", counter))
					if _, err := bot.Send(msg); err != nil {
						panic(err)
					}
				}
			}
			if update.Message.Text != "" {
				switch update.Message.Text {
				case "–ü–æ–ª—É—á–∏—Ç—å –∑–∞–π–º üí∏":
					msg := tgbotapi.NewMessage(chatID, welcome)
					msg.ReplyMarkup = secondBtn
					if _, err := bot.Send(msg); err != nil {
						panic(err)
					}

				case "–î–æ 15.000—Ä üí∞":
					msg := tgbotapi.NewMessage(chatID, credit15)
					msg.ReplyMarkup = firstBtn
					if _, err := bot.Send(msg); err != nil {
						panic(err)
					}
				case "–î–æ 30.000—Ä üí∞":
					msg := tgbotapi.NewMessage(chatID, credit30)
					msg.ReplyMarkup = firstBtn
					if _, err := bot.Send(msg); err != nil {
						panic(err)
					}
				case "–î–æ 50.000—Ä üí∞":
					msg := tgbotapi.NewMessage(chatID, credit50)
					msg.ReplyMarkup = firstBtn
					if _, err := bot.Send(msg); err != nil {
						panic(err)
					}
				}
			}
		case _ := <-ticker.C:
			wakeUp(lastUpdate, bot)

		}
	}
}

func wakeUp(lastUpdate map[int64]time.Time, bot *tgbotapi.BotAPI) {
	timeNow := time.Now()
	for chatID, lastTime := range lastUpdate {
		diff := timeNow.Sub(lastTime)
		if diff > time.Duration(4*time.Hour) {
			msg := tgbotapi.NewMessage(chatID, timerText)
			if _, err := bot.Send(msg); err != nil {
				panic(err)
			}
		}
		lastUpdate[chatID] = timeNow.Add(time.Duration(24) * time.Hour)

	}

}
